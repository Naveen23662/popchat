<script>
document.addEventListener("DOMContentLoaded", () => {

  let stream = null;
  let audioMuted = false;
  let videoOff = false;

  // VIDEO
  const localVideo = document.getElementById("localVideo");

  // BUTTONS
  const startBtn = document.getElementById("startCam");
  const muteBtn = document.querySelector(".controls button:nth-of-type(2)");
  const camOffBtn = document.querySelector(".controls button:nth-of-type(3)");
  const nextBtn = document.querySelector(".controls button:nth-of-type(4)");

  // CHAT
  const chatInput = document.getElementById("chatInput");
  const chatMessages = document.getElementById("chatMessages");
  const sendBtn = document.getElementById("sendBtn");

  // Enable buttons safely
  muteBtn.disabled = false;
  camOffBtn.disabled = false;
  nextBtn.disabled = false;

  // -------- CAMERA --------
  startBtn.onclick = async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
      });
      localVideo.srcObject = stream;
      audioMuted = false;
      videoOff = false;
      muteBtn.textContent = "Mute";
      camOffBtn.textContent = "Cam Off";
    } catch (e) {
      alert("Camera or mic permission denied");
    }
  };

  // -------- MUTE --------
  muteBtn.onclick = () => {
    if (!stream) return;

    stream.getAudioTracks().forEach(track => {
      track.enabled = !track.enabled;
      audioMuted = !track.enabled;
    });

    muteBtn.textContent = audioMuted ? "Unmute" : "Mute";
  };

  // -------- CAM OFF --------
  camOffBtn.onclick = () => {
    if (!stream) return;

    stream.getVideoTracks().forEach(track => {
      track.enabled = !track.enabled;
      videoOff = !track.enabled;
    });

    camOffBtn.textContent = videoOff ? "Cam On" : "Cam Off";
  };

  // -------- NEXT --------
  nextBtn.onclick = () => {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }

    localVideo.srcObject = null;
    chatMessages.innerHTML = "";
    audioMuted = false;
    videoOff = false;

    muteBtn.textContent = "Mute";
    camOffBtn.textContent = "Cam Off";
  };

  // -------- CHAT --------
  function sendMessage() {
    const msg = chatInput.value.trim();
    if (!msg) return;

    const div = document.createElement("div");
    div.textContent = "You: " + msg;
    div.style.padding = "6px";
    div.style.fontSize = "13px";

    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    chatInput.value = "";
  }

  sendBtn.onclick = sendMessage;

  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });

});
</script>

