<script>
document.addEventListener("DOMContentLoaded", () => {

  // -------- STATE --------
  let stream = null;
  let socket = null;

  // -------- ELEMENTS --------
  const localVideo = document.getElementById("localVideo");

  const startBtn = document.getElementById("startCam");
  const muteBtn = document.querySelector(".controls button:nth-of-type(2)");
  const camOffBtn = document.querySelector(".controls button:nth-of-type(3)");
  const nextBtn = document.querySelector(".controls button:nth-of-type(4)");

  const chatInput = document.getElementById("chatInput");
  const chatMessages = document.getElementById("chatMessages");
  const sendBtn = document.getElementById("sendBtn");

  muteBtn.disabled = false;
  camOffBtn.disabled = false;
  nextBtn.disabled = false;

  // -------- WEBSOCKET --------
  function connectSocket() {
    socket = new WebSocket(
      (location.protocol === "https:" ? "wss://" : "ws://") + location.host
    );

    socket.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "chat") {
        addMessage("Stranger", data.message);
      }

      if (data.type === "status") {
        addStatus(data.message);
      }
    };

    socket.onclose = () => {
      addStatus("Disconnected from server");
    };
  }

  connectSocket();

  // -------- CAMERA --------
  startBtn.onclick = async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = stream;
    } catch {
      alert("Camera permission denied");
    }
  };

  muteBtn.onclick = () => {
    if (!stream) return;
    stream.getAudioTracks().forEach(t => t.enabled = !t.enabled);
  };

  camOffBtn.onclick = () => {
    if (!stream) return;
    stream.getVideoTracks().forEach(t => t.enabled = !t.enabled);
  };

  // -------- NEXT --------
  nextBtn.onclick = () => {
    if (socket && socket.readyState === 1) {
      socket.send(JSON.stringify({ type: "next" }));
    }
    chatMessages.innerHTML = "";
  };

  // -------- CHAT --------
  function sendMessage() {
    const msg = chatInput.value.trim();
    if (!msg || !socket || socket.readyState !== 1) return;

    addMessage("You", msg);
    socket.send(JSON.stringify({ type: "chat", message: msg }));
    chatInput.value = "";
  }

  sendBtn.onclick = sendMessage;

  chatInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });

  // -------- UI HELPERS --------
  function addMessage(sender, text) {
    const div = document.createElement("div");
    div.textContent = sender + ": " + text;
    div.style.padding = "6px";
    div.style.fontSize = "13px";
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function addStatus(text) {
    const div = document.createElement("div");
    div.textContent = "â€¢ " + text;
    div.style.opacity = "0.7";
    div.style.fontSize = "12px";
    div.style.padding = "4px";
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

});
</script>

